<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>test</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="http://s.4cm.com/ui/bootstrap4/css/bootstrap.min.css" />
    <link rel="stylesheet" href="http://s.4cm.com/ui/iconfont/bootstrap.css" />
    <script type="text/javascript" src="http://s.4cm.com/common/jquery/3.3.1.min.js"></script>
    <script type="text/javascript" src="http://s.4cm.com/ui/bootstrap4/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="http://s.4cm.com/ui/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" />
    <script type="text/javascript" src="http://s.4cm.com/ui/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="http://s.4cm.com/ui/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    <link rel="stylesheet" href="http://s.4cm.com/ui/summernote/summernote-lite.css" />
    <script type="text/javascript" src="http://s.4cm.com/ui/summernote/summernote-lite.min.js"></script>
    <script type="text/javascript" src="http://s.4cm.com/ui/summernote/lang/summernote-zh-CN.js"></script>
</head>
<body>
</body>
</html>
<script>

    const App = {
        pages: {},
        /**
         * 页面对象(基本包含按钮组、表单、筛选器、表格、分页器)
         */
        page: {
            id: '',//页面ID
            formApiUrl: '',//表单接口
            dataApiUrl: '',//数据接口
            data: {
                page: 1,//当前页码
                onPageNum: 1,//每页记录数
                recordNum: 0,//总记录数
                pageSideNum: 2,//两侧显示的页码数量
                keys: [],//键名数组，键名索引和数据索引保持一致
                list: [],//列表数据
                thead: [],//表头信息
                colKey: -1,//选定列对应的索引
				form: {},
            },
            timerBasicParam: {//时间选择器基本参数(页面初始化后删掉)
                language: 'zh-CN',
                weekStart: 1,
                todayBtn: 1,
                todayHighlight: 1,
                autoclose: 1,
                maxView: 4,
                startView: 2,
                // format: 'yyyy-mm-dd',
                // minView: 1,
            },
            //检查是否保留关键字
            checkReservedKeywords: function(key){
                return ['id', 'formApiUrl', 'dataApiUrl', 'data', 'on', 'off', 'clean'].indexOf(key) >= 0;
            },
            //设置属性
            on: function (key, value) {
                if (!this.checkReservedKeywords(key)) {
                    if (this.hasOwnProperty(key) && typeof (this[key]) === 'function') {
                        let mapKey = `${key}_${parseInt(key, 32)}`;
                        if (!this.hasOwnProperty(mapKey)) {
                            this[mapKey] = [];
                            this[mapKey].push(this[key]);
                        }
                        this[mapKey].push(value);
                        this[key] = () => {
                            Object.keys(this[mapKey]).forEach(i => {
                                this[mapKey][i]();
                            })
                        }
                    } else {
                        this[key] = value;
                    }
                }
            },
            //移除属性
            off: function(key){
                if (!this.checkReservedKeywords(key)) {
                    delete this[key];
                    delete this[`${key}_${parseInt(key, 32)}`];
                }
            },
            //创建页面后清除无用属性
            clean: function () {
                delete this.timerBasicParam;
                delete this.renderBtnGroup;
                delete this.renderForm;
            },
            /**
             * 表单提交
             */
            formSubmit: function(){
                console.log(this.data.form);
            },
            /**
             * 表单取消
             */
            formCancel: function(){
                $('#' + this.id).find('form').hide();
            },
            /**
             * 渲染按钮组(页面初始化后删掉)
             * @param cfg
             * [
             *     {
             *         name: '',//名称
             *         class: '',//样式
             *         click: '',//点击事件(匿名函数无法调用page的数据)
             *     },xN
             * ]
             */
            renderBtnGroup: function (cfg) {
                let group = $('<div class="container-row"></div>');
                Object.keys(cfg).forEach(i => {
                    let btn = $(`<button class="btn btn-default ${cfg[i].class}">${cfg[i].name}</button>`);
                    if (cfg[i].click) {
                        btn.on('click', () => this[cfg[i].click]());
                    }
                    group.append(btn);
                });
                $('#' + this.id).append(group);
            },
            /**
             * 渲染表单(页面初始化后删掉)
             * @param cfg
			 * [
			 *     {
			 *         key: '',//表单元素的key
			 *         name: '',//表单元素的名字
			 *         type: 'text',//表单类型[select/text/textarea/password/radio/checkbox/number/tel/timer/html/files]
			 *         placeholder: '',//描述文字
			 *         options: {//选项(仅select/radio/checkbox类型用到)
			 *         		value: text, //选项值与提示文字键值对
			 *         },
			 *         unit: '',//单位描述(空表示没有单位)
			 *         value: '',//值(checkbox/files类型为数组)
			 *         default: '',//默认值(checkbox/files类型为数组)
			 *         regex: '',//检验值的正则表达式(空表示不校验)
			 *         tips: '',//校验不通过时的提示信息
			 *         format: '',//时间格式(仅timer类型用到)
			 *         column: 0,//所占列数(一行12列)
			 *     },xN
			 * ]
             */
            renderForm: function (cfg) {
                let form = $('<form class="container-row"></form>');
                let colNumOnRow = 0;//一行的列数
                let lastIdx = cfg.length - 1;//最后一个配置的索引
                let rowBox = $('<div class="row"></div>');
            	Object.keys(cfg).forEach(i => {
					let colBox,
                        html = '',
                        info = cfg[i];
					//校正参数
					info.name = info.hasOwnProperty('name') ? info.name : '';
					info.type = info.hasOwnProperty('type') ? info.type : 'text';
					info.placeholder = info.hasOwnProperty('placeholder') ? info.placeholder : '';
					info.options = info.hasOwnProperty('options') ? info.options : {};
					info.unit = info.hasOwnProperty('unit') ? info.unit : '';
					info.default = info.hasOwnProperty('default') ? info.default : '';
					info.regex = info.hasOwnProperty('regex') ? info.regex : '';
					info.tips = info.hasOwnProperty('tips') ? info.tips : '';
					info.format = info.hasOwnProperty('format') ? info.format : '';
					info.column = info.hasOwnProperty('column') ? info.column : 12;
					if(info.type == 'checkbox' && !Array.isArray(info.default)){
					    if(info.default !== ''){
                            info.default = [info.default.toString()];
                        }
						else{
                            info.default = [];
                        }
					}
                    info.value = info.default;
					//写到data的表单映射
            		this.data.form[info.key] = {
            			default: info.default,
						value: info.value,
						regex: info.regex,
						tips: info.tips,
					}
					//单选和多选
					if(['radio','checkbox'].indexOf(info.type) >= 0){
						Object.keys(info.options).forEach(key => {
						    let checked = '';
						    if((info.type == 'radio' && info.default == key)
                            || (info.type == 'checkbox' && info.default.indexOf(key) >= 0)){
						        checked = 'checked="checked"';
                            }
                            html += `<label>
                                    <input type="${info.type}" name="${info.key}" value="${key}" ${checked}>
                                    ${info.options[key]}
                                    </label>`;
						});
                        html = `<div class="form-multiselect-row">${html}</div>`;
					}
					//文本框和富文本
					else if(['textarea','html'].indexOf(info.type) >= 0){
					    let sign = info.type == 'html' ? 'editor="1"' : '';
					    html = `<textarea name="${info.key}" class="form-control" placeholder="${info.placeholder}" ${sign}>${info.value}</textarea>`;
                    }
                    //下拉选择框
					else if(info.type == 'select'){
                        Object.keys(info.options).forEach(key => {
                            let selected = info.default == key ? 'selected="selected"' : '';
                            html += `<option value="${key}" ${selected}>${info.options[key]}</option>`;
                        });
                        html = `<select name="${info.key}" class="form-control">${html}</select>`;
                    }
					//input输入框
                    else{
                        let appendHtml = '',
                            readOnly = info.type == 'timer' ? 'readOnly=true' : '';
                        if(info.unit){
                            appendHtml = `<div class="input-group-append">
                                                <span class="input-group-text">${info.unit}</span>
                                            </div>`;
                        }
                        html = `<div class="input-group">
                                    <input type="text" class="form-control" name="${info.key}"
                                    placeholder="${info.placeholder}" value="${info.value}" ${readOnly}>
                                     ${appendHtml}
                                </div>`;
                    }
					//创建列对象
					let colNum = info.column > 0 ? info.column : 12;
                    colBox = $(`<div class="col-sm-${colNum}">
                                    <label>${info.name}</label>
                                    ${html}
                                </div>`);
                    //绑定表单元素的change事件
                    colBox.find(`[name=${info.key}]`).each((j, e) => {
                        $(e).on('change', () => {
                            let value = $(e).val();
                            if(info.type == 'checkbox'){
                                if($(e).prop('checked')){
                                    this.data.form[info.key].value.push(value);
                                }
                                else{
                                    this.data.form[info.key].value.splice(
                                        this.data.form[info.key].value.indexOf(value), 1);
                                }
                            }
                            else{
                                this.data.form[info.key].value = value;
                            }
                        })
                    });
                    //初始化时间选择器
                    if(info.type == 'timer'){
                        this.timerBasicParam.minView = 2;
                        this.timerBasicParam.format = info.format ? info.format : 'yyyy-mm-dd';
                        if(/h/i.test(this.timerBasicParam.format)){
                            this.timerBasicParam.minView = 1;
                        }
                        colBox.find('input').datetimepicker(this.timerBasicParam);
                    }
                    //看一下应该放到哪一行
					colNumOnRow += colNum;
					if(colNumOnRow <= 12){
                        rowBox.append(colBox);
                    }
                    if(colNumOnRow >= 12 || i == lastIdx){
                        form.append(rowBox);
                        rowBox = $('<div class="row"></div>');
                        if(colNumOnRow > 12){
                            rowBox.append(colBox);
                            colNumOnRow = colNum;
                        }
                        else{
                            colNumOnRow = 0;
                        }
                    }
                    if(colNumOnRow >= 12 && i == lastIdx){
                        form.append(rowBox);
                    }
				});
            	//提交和取消按钮
                let actions = $('<div class="row">' +
                                '<div class="col-12">' +
                                    '<button name="submit" class="btn btn-success">提交</button>' +
                                    '<button name="cancel" class="btn btn-default">取消</button>' +
                                '</div>' +
                            '</div>');
                actions.find('[name=cancel]').on('click', () => {
                    this.formCancel();
                });
                form.append(actions);
                form.on('submit', (e) => {
                    e.preventDefault();
                    this.formSubmit();
                });
                $('#' + this.id).append(form);
                //初始化富文本
                $('#' + this.id).find('[editor=1]').each((i, e) => {
                    $(e).summernote({
                        lang: 'zh-CN',
                        height: 150,
                        callbacks: {
                            onChange: (contents) => {
                                this.data.form[$(e).attr('name')].value = contents;
                            }
                        }
                    });
                });
            },
        },
        renderPage: function (page, config) {
            if (!this.pages.hasOwnProperty(page)) {
                $('body').append($(`<div id="${page}"></div>`));
                this.pages[page] = Object.assign({}, this.page);
                this.pages[page].id = page;
            }
            if (config.btnGroups) {
                this.pages[page].renderBtnGroup(config.btnGroups);
                delete config.btnGroups;
            }
            if (config.form){
                this.pages[page].renderForm(config.form);
                delete config.form;
            }
            Object.keys(config).forEach(key => {
                this.pages[page].on(key, config[key]);
            });
            this.pages[page].clean();
        }
    }
    $(function () {
        // App.renderPage('apage', {
        // 	addNew: function(){
        // 		console.log('new2')
        // 	},
        // });
        App.renderPage('bpage', {
            btnGroups: [
                {
                    name: '新增',
                    class: 'btn-primary',
                    click: 'addNew',
                }
            ],
            addNew: function () {
                console.log(this.id)
                $('#'+this.id).find('form').show();
            },
        	form: [
                {
                    key: 'sitename',
                    name: '站点名称',
                    type: 'timer',
                    placeholder: '请输入站点名称',
                    default: '',
                    column: 4,
                },
                {
                    key: 'sitecontent',
                    name: '站点内容',
                    type: 'checkbox',
                    options: {
                        0: '个人',
                        1: '企业',
                        2: '政府',
                        3: '公益'
                    },
                    default: 0,
                },
        	],
        });
    })

</script>